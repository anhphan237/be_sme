<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sme.be_sme.modules.billing.infrastructure.mapper.DunningCaseMapperExt">

    <select id="selectByCompanyIdAndSubscriptionId" resultMap="com.sme.be_sme.modules.billing.infrastructure.mapper.DunningCaseMapper.BaseResultMap">
        select dunning_case_id, company_id, subscription_id, retry_count, next_retry_at,
               status, created_at, updated_at
        from dunning_cases
        where company_id = #{companyId,jdbcType=VARCHAR}
          and subscription_id = #{subscriptionId,jdbcType=VARCHAR}
        order by created_at desc
        limit 1
    </select>

    <select id="selectPendingRetryDue" resultMap="com.sme.be_sme.modules.billing.infrastructure.mapper.DunningCaseMapper.BaseResultMap">
        select dunning_case_id, company_id, subscription_id, retry_count, next_retry_at,
               status, created_at, updated_at
        from dunning_cases
        where status = 'PENDING_RETRY'
          and next_retry_at is not null
          and next_retry_at &lt;= #{asOf,jdbcType=TIMESTAMP}
        order by next_retry_at asc
    </select>
</mapper>
