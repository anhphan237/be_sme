<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sme.be_sme.modules.onboarding.infrastructure.mapper.OnboardingTemplateMapperExt">

    <!-- List: onboarding_templates has onboarding_template_id, company_id, name, description, status, created_by, created_at, updated_at -->
    <select id="selectByCompanyIdAndStatus" resultMap="com.sme.be_sme.modules.onboarding.infrastructure.mapper.OnboardingTemplateMapper.BaseResultMap">
        select onboarding_template_id, company_id, name, description, status, created_by,
               created_at, updated_at
        from onboarding_templates
        where company_id = #{companyId,jdbcType=VARCHAR}
        <if test="status != null and status != ''">
            and status = #{status,jdbcType=VARCHAR}
        </if>
        order by created_at desc
    </select>

    <!-- Reuse BaseResultMap generated by MBG -->
    <select id="selectTemplateByIdAndCompany"
            resultMap="com.sme.be_sme.modules.onboarding.infrastructure.mapper.OnboardingTemplateMapper.BaseResultMap">
        select onboarding_template_id, company_id, name, description, status, created_by, created_at, updated_at
        from onboarding_templates
        where onboarding_template_id = #{templateId,jdbcType=VARCHAR}
          and company_id = #{companyId,jdbcType=VARCHAR}
    </select>

    <!-- Checklist templates under a onboarding_template -->
    <!-- checklist_templates: checklist_template_id, company_id, onboarding_template_id, name, stage, sort_order, status -->
    <select id="selectChecklistRows"
            resultType="com.sme.be_sme.modules.onboarding.infrastructure.persistence.model.ChecklistTemplateRow">
        select
            checklist_template_id as checklistTemplateId,
            name                 as name,
            sort_order           as orderNo,
            status               as status
        from checklist_templates
        where company_id = #{companyId,jdbcType=VARCHAR}
          and onboarding_template_id = #{templateId,jdbcType=VARCHAR}
        order by sort_order asc
    </select>

    <!-- Task templates under checklist_templates of this onboarding_template (task_templates has title, sort_order, no is_baseline) -->
    <select id="selectBaselineTaskRows"
            resultType="com.sme.be_sme.modules.onboarding.infrastructure.persistence.model.TaskTemplateRow">
        select
            tt.task_template_id       as taskTemplateId,
            tt.checklist_template_id  as checklistTemplateId,
            tt.title                  as name,
            tt.description           as description,
            tt.sort_order            as orderNo,
            tt.status                as status
        from task_templates tt
                 join checklist_templates ct
                      on ct.checklist_template_id = tt.checklist_template_id
        where ct.company_id = #{companyId,jdbcType=VARCHAR}
          and ct.onboarding_template_id = #{templateId,jdbcType=VARCHAR}
        order by tt.sort_order asc
    </select>

</mapper>
