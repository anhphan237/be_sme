<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sme.be_sme.modules.onboarding.infrastructure.mapper.OnboardingTemplateMapperExt">

    <!-- Reuse BaseResultMap generated by MBG -->
    <select id="selectTemplateByIdAndCompany"
            resultMap="com.sme.be_sme.modules.onboarding.infrastructure.mapper.OnboardingTemplateMapper.BaseResultMap">
        select onboarding_template_id, company_id, name, description, status, created_by, created_at, updated_at
        from onboarding_templates
        where onboarding_template_id = #{templateId,jdbcType=VARCHAR}
          and company_id = #{companyId,jdbcType=VARCHAR}
    </select>

    <!-- Checklist templates under a onboarding_template -->
    <!-- ASSUME TABLE: checklist_templates(company_id, onboarding_template_id, checklist_template_id, name, description, order_no, status) -->
    <select id="selectChecklistRows"
            resultType="com.sme.be_sme.modules.onboarding.infrastructure.persistence.model.ChecklistTemplateRow">
        select
            checklist_template_id as checklistTemplateId,
            name                 as name,
            description          as description,
            order_no             as orderNo,
            status               as status
        from checklist_templates
        where company_id = #{companyId,jdbcType=VARCHAR}
          and onboarding_template_id = #{templateId,jdbcType=VARCHAR}
        order by order_no asc
    </select>

    <!-- Baseline task templates -->
    <!-- ASSUME TABLE: task_templates(task_template_id, checklist_template_id, name, description, order_no, status, is_baseline)
         and checklist_templates(checklist_template_id, onboarding_template_id, company_id)
    -->
    <select id="selectBaselineTaskRows"
            resultType="com.sme.be_sme.modules.onboarding.infrastructure.persistence.model.TaskTemplateRow">
        select
            tt.task_template_id       as taskTemplateId,
            tt.checklist_template_id  as checklistTemplateId,
            tt.name                   as name,
            tt.description            as description,
            tt.order_no               as orderNo,
            tt.status                 as status
        from task_templates tt
                 join checklist_templates ct
                      on ct.checklist_template_id = tt.checklist_template_id
        where ct.company_id = #{companyId,jdbcType=VARCHAR}
          and ct.onboarding_template_id = #{templateId,jdbcType=VARCHAR}
          and tt.is_baseline = true
        order by tt.order_no asc
    </select>

</mapper>
